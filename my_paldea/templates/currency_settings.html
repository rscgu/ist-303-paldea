{% extends 'base.html' %}
{% block container %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h2>Currency Settings</h2>
            <a href="{{ url_for('paldea_app.home') }}" class="btn btn-secondary mb-3">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Preferred Currency</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Select your preferred currency for displaying amounts throughout the application.</p>
                    <form method="POST">
                        <div class="mb-3">
                            <label for="preferred_currency_id" class="form-label">Preferred Currency</label>
                            <select class="form-select" id="preferred_currency_id" name="preferred_currency_id" required>
                                {% for currency in currencies %}
                                <option value="{{ currency.id }}" {% if currency.id == current_preferred %}selected{% endif %}>
                                    {{ currency.code }} - {{ currency.name }} ({{ currency.symbol }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Preferences</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Currency Converter</h5>
                </div>
                <div class="card-body">
                    <form id="converterForm">
                        <div class="mb-3">
                            <label for="from_currency" class="form-label">From</label>
                            <select class="form-select" id="from_currency" required>
                                {% for currency in currencies %}
                                <option value="{{ currency.code }}" {% if currency.id == current_preferred %}selected{% endif %}>
                                    {{ currency.code }} - {{ currency.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="to_currency" class="form-label">To</label>
                            <select class="form-select" id="to_currency" required>
                                {% for currency in currencies %}
                                <option value="{{ currency.code }}" {% if currency.id == current_preferred %}selected{% endif %}>
                                    {{ currency.code }} - {{ currency.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" class="form-control" id="amount" step="0.01" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Convert</button>
                    </form>
                    <div id="conversionResult" class="mt-3" style="display: none;">
                        <div class="alert alert-success">
                            <h6>Conversion Result</h6>
                            <p id="resultText"></p>
                            <p class="text-muted mb-0"><small>Rate: <span id="rateText"></span></small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Recent Conversions</h5>
                    <a href="{{ url_for('paldea_app.conversion_history') }}" class="btn btn-sm btn-primary">View Full History</a>
                </div>
                <div class="card-body">
                    {% if conversions %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Amount</th>
                                    <th>Converted</th>
                                    <th>Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for conversion in conversions %}
                                <tr>
                                    <td>{{ conversion.date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ conversion.from_currency.code }} {{ conversion.from_currency.symbol }}</td>
                                    <td>{{ conversion.to_currency.code }} {{ conversion.to_currency.symbol }}</td>
                                    <td>{{ "%.2f"|format(conversion.amount) }}</td>
                                    <td>{{ "%.2f"|format(conversion.converted_amount) }}</td>
                                    <td>{{ "%.6f"|format(conversion.rate) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No conversion history yet. Use the converter above to get started.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('converterForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fromCurrency = document.getElementById('from_currency').value;
        const toCurrency = document.getElementById('to_currency').value;
        const amount = parseFloat(document.getElementById('amount').value);
        
        if (fromCurrency === toCurrency) {
            document.getElementById('resultText').textContent = `${amount} ${fromCurrency}`;
            document.getElementById('rateText').textContent = '1.0';
            document.getElementById('conversionResult').style.display = 'block';
            return;
        }
        
        try {
            const response = await fetch('{{ url_for("paldea_app.convert_currency") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    from_currency: fromCurrency,
                    to_currency: toCurrency,
                    amount: amount
                })
            });
            
            const data = await response.json();
            
            if (data.converted_amount !== undefined) {
                document.getElementById('resultText').textContent = 
                    `${amount} ${fromCurrency} = ${data.converted_amount} ${toCurrency}`;
                document.getElementById('rateText').textContent = data.rate;
                document.getElementById('conversionResult').style.display = 'block';
            } else {
                alert('Conversion failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
</script>
{% endblock %}

